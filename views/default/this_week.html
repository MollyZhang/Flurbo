{{extend 'layout.html'}}

<script id="template" type="text/ractive">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <table class="table">
                <thead>
                    <tr>
                        <th>Budget Category</th>
                        <th>Budget Per Week</th>
                        <th>You have spent</th>
                        <th>Budget left</th>
                        <th>Add spending</th>
                    </tr>
                </thead>
                <tbody>
                    {% #categories:i %}
                    <tr>
                        <td>{% categories[i]['name'] %}</td>
                        <td>{% categories[i]['budget'] %}</td>
                        <td>{% spendings[i] %}</td>
                        <td>{% leftover[i] %}</td>
                        <td><input id="spending_{% i %}"/>
                            <span class="btn btn-success btn-sm"
                            data-index="{% i %}"
                            on-click="add-spending">Add</span>
                        </td>
                    </tr>
                    {% /categories %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
</script>

<div id="target"></div>
<div class="container">
    <a class="btn btn-info" href="{{=URL('default', 'edit')}}">change my budget</a>
    <a class="btn btn-warning" href="{{=URL('default', 'spending_history')}}">view my spending history</a>
    <a class="btn btn-success" href="{{=URL('default', 'summary')}}">summary</a>
</div>




<script>
$(function() {
    var MAIN = new Ractive({
        el: '#target',
        template: '#template',
        delimiters: ['{%', '%}'],
        tripleDelimiters: ['{%%', '%%}'],
        data: {
            categories: [],
            spendings: [],
            leftover:[]
        }
    });

    $.ajax("{{=URL('default', 'load_data', user_signature=True)}}",
        {
        method: 'POST',
        success: function (data) {
            MAIN.set('categories', data['categories']);
            MAIN.set('spendings', data['spendings']);
            reset_leftover();
            }
        }
    );

    function reset_leftover(){
        var categories = MAIN.get('categories');
        var spendings = MAIN.get('spendings');
        var leftover = [];
        for (i=0;i<categories.length;i++){
            var this_left_over = parseInt(categories[i]['budget']) - parseInt(spendings[i]);
            leftover.push(this_left_over);
        }
        MAIN.set('leftover', leftover);
    }

    MAIN.on('add-spending', function(e) {
        var index = $(e.original.target).data('index');
        var amount = $('#spending_' + index).val();
        var category_id = MAIN.get('categories')[index]['id'];
        spendings = MAIN.get('spendings');
        $.ajax("{{=URL('default', 'save_spending_history', user_signature=True)}}",
            {
            method: 'POST',
            data: {
                category_id: category_id,
                amount: amount
            },
            success: function (data) {
                $('#spending_' + index).val('');
                if (parseInt(amount)) {spendings[index] += parseInt(amount);}
                MAIN.set('spendings', spendings);
                reset_leftover();
                }
            }
        );
    });

});
</script>