{{extend 'layout.html'}}
        
<div class="container">
    <div class="jumbotron">
        <h3>Initialize your budget system</h3>
    </div>
    <div id="target"></div>
</div>

<script id="template" type="text/ractive">
    <div class='panel panel-success'>
        <div class='panel-heading'>
        <span>Your monthly income: </span>
        {% #if adding_income %}
            <input value="{% income %}" />
            <span class="btn btn-default btn-sm" on-click='save_income'>Save</span>
        {% else %}
            <span>{% income %}</span>
            <span class="btn btn-default btn-sm" on-click="edit_income">edit</span>
        {% /if %}
        </div>
    </div>

    <div class="panel panel-success">
        <div class="panel-heading">
            <h3>Here is the budget categories that changes over time: </h3>
            {% #if !adding_budget %}
                <div class="btn btn-default" on-click="add-budget">add budget category</div>
            {% else %}
                <div class="btn btn-default" on-click="save-budget">save budget category</div>
            {% /if %}
        </div>
        <table class="table">
        <thead>
            <tr>
                <th>Budget Category</th>
                <th>Budget Per Week</th>
            </tr>
        </thead>
        <tbody>
            {% #categories:i %}
            <tr>
                <td>{% categories[i]['name'] %}</td>
                <td>{% categories[i]['budget'] %}</td>
            </tr>
            {% /categories %}

            {% #if adding_budget %}
            <tr>
                <td><input placeholder="new budget category" id="category_name" /></td>
                <td><input placeholder="0" id="category_budget" /></td>
            </tr>
            {% /if %}
        </tbody>
        </table>
    </div>

    <div class="panel panel-success">
        <div class="panel-heading">
            <h3>Here is the budget categories that's fixed per month: </h3>
            {% #if !adding_fixed %}
                <div class="btn btn-default" on-click="add_fixed">add fixed spending</div>
            {% else %}
                <div class="btn btn-default" on-click="save_fixed">save fixed spending</div>
            {% /if %}
        </div>
        <table class="table">
        <thead>
            <tr>
                <th>Fixed Spending Name</th>
                <th>Amount Per Month</th>
            </tr>
        </thead>
        <tbody>
            {% #fixed_spendings:i %}
            <tr>
                <td>{% fixed_spendings[i]['name'] %}</td>
                <td>{% fixed_spendings[i]['amount'] %}</td>
            </tr>
            {% /fixed_spendings %}

            {% #if adding_fixed %}
            <tr>
                <td><input placeholder="new fixed spending" id="spending_name" /></td>
                <td><input placeholder="0" id="spending_amount" /></td>
            </tr>
            {% /if %}
        </tbody>
        </table>
    </div>

</script>

<script>
$(function() {
    var MAIN = new Ractive({
        el: '#target',
        template: '#template',
        delimiters: ['{%', '%}'],
        tripleDelimiters: ['{%%', '%%}'],
        data: {
            adding_income: true,
            adding_budget: false,
            adding_fixed: false,
            income: 0,
            categories: [],
            fixed_spendings: []
        }
    });

    $.ajax("{{=URL('default', 'load_data', user_signature=True)}}",
        {
        method: 'POST',
        success: function (data) {
            MAIN.set('categories', data['categories']);
            MAIN.set('fixed_spendings', data['fixed_spendings']);
            }
        }
  );

    MAIN.on('add-budget', function(){
        MAIN.set('adding_budget', true);
    });

    MAIN.on('save-budget', function(){
        var name = $('#category_name').val();
        var amount = $('#category_budget').val();
        $.ajax("{{=URL('default', 'save_budget', user_signature=True)}}",
            {
            method: 'POST',
            data: {
                name: name,
                amount: amount
                }
            }
        );
        MAIN.set('adding_budget', false);
        var new_category = {"name": name, "budget": amount};
        var updated_category = MAIN.get('categories');
        updated_category.push(new_category);
        MAIN.set('categories', updated_category);
    });

    MAIN.on("save_income", function() {
        MAIN.set("adding_income", false);
        income = MAIN.get('income');
        $.ajax("{{=URL('default', 'save_income', user_signature=True)}}",
            {
            method: 'POST',
            data: {
                income: income
                }
            }
        );
    });
    MAIN.on("edit_income", function() {
        MAIN.set("adding_income", true);
    });


    MAIN.on('add_fixed', function(){
        MAIN.set('adding_fixed', true);
    });

    MAIN.on('save_fixed', function(){
        var name = $('#spending_name').val();
        var amount = $('#spending_amount').val();
        $.ajax("{{=URL('default', 'save_fixed_spending', user_signature=True)}}",
            {
            method: 'POST',
            data: {
                name: name,
                amount: amount
                }
            }
        );
        MAIN.set('adding_fixed', false);
        var new_spending = {"name": name, "amount": amount};
        var updated_spending = MAIN.get('fixed_spendings');
        updated_spending.push(new_spending);
        MAIN.set('fixed_spendings', updated_spending);
    });
});
</script>
